name: Publicar
on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  publish:
    name: publicar
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: setup python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'
        cache-dependency-path: './vista/requirements.txt'

    - name: python install
      run: |
        python -m pip install --upgrade pip
        pip install -r vista/requirements.txt

    - name: preparar mapa
      run: |
        mkdir -p temporal
        ./preparar_mapa.py

    - name: instalar tippecanoe
      run: |
        sudo apt-get update
        sudo apt-get install -y tippecanoe

    - name: crear pmtiles
      run: |
        tippecanoe -Z8 -z14 \
          --no-line-simplification \
          --no-simplification-of-shared-nodes \
          --no-tiny-polygon-reduction \
          --detect-shared-borders \
          --maximum-tile-bytes=1500000 \
          -f -o atlas.pmtiles \
          temporal/manzanos.geojson

    - name: publish pmtiles
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GIT_AUTHOR_NAME: atlasurbano_bot
        GIT_AUTHOR_EMAIL: atlasurbano_bot@example.com
        GIT_COMMITTER_NAME: atlasurbano_bot
        GIT_COMMITTER_EMAIL: atlasurbano_bot@example.com
        REPO: ${{ github.repository }}
      run: |
        mkdir -p /tmp/pmtiles-publish
        mv atlas.pmtiles /tmp/pmtiles-publish/atlas.pmtiles
        cd /tmp/pmtiles-publish
        git init -b pmtiles
        git config user.name  "$GIT_AUTHOR_NAME"
        git config user.email "$GIT_AUTHOR_EMAIL"
        git add -A
        git commit -m "Publish pmtiles"
        git remote add origin "https://x-access-token:${GH_TOKEN}@github.com/${REPO}.git"
        git push --force origin pmtiles

    - name: write pmtiles url module
      env:
        PMTILES_URL: https://raw.githubusercontent.com/${{ github.repository }}/pmtiles/atlas.pmtiles
      run: |
        printf 'export const PMTILES_URL = "%s";\n' "$PMTILES_URL" > vista/src/components/pmtiles-url.js
        echo "PMTILES_URL set to $PMTILES_URL"

    - name: setup docs
      run: |
        mkdir -p docs

    - name: setup node
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: "npm"
        cache-dependency-path: ./vista/package-lock.json

    - name: dependencias
      working-directory: ./vista
      run: npm ci

    - name: build
      working-directory: ./vista
      run: npm run build

    - name: ensure .nojekyll
      run: touch ./docs/.nojekyll

    - name: publicar
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs
        force_orphan: true
        user_name: atlasurbano_bot
        user_email: atlasurbano_bot@example.com